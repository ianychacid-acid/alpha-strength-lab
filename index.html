<!DOCTYPE html>
<html lang="zh-TW" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alpha Strength V2.2</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #E2E8F0; font-size: 16px; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        /* éš±è—æ²è»¸ä½†å¯æ»‘å‹• */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-24">

<div id="app" class="flex flex-col h-full">

    <div class="navbar bg-base-200 border-b border-white/10 px-4 shadow-lg sticky top-0 z-30">
        <div class="flex-1">
            <span class="text-xl md:text-2xl font-black text-primary tracking-tight">Alpha<span class="text-white">Strength</span></span>
            <span class="ml-2 badge badge-outline text-xs">Coach View</span>
        </div>
        <div class="flex-none">
            <a :href="lineCallUrl" target="_blank" class="btn btn-circle btn-ghost text-success">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
            </a>
        </div>
    </div>

    <main class="p-4 md:p-6 space-y-8 flex-1 overflow-y-auto">
        
        <div v-if="loading" class="flex flex-col items-center justify-center py-20 space-y-4">
            <span class="loading loading-bars loading-lg text-primary"></span>
            <p class="text-gray-400 animate-pulse">æ•¸æ“šåŒæ­¥ä¸­...</p>
        </div>

        <div v-if="errorMsg" class="alert alert-error shadow-lg">
            <span>{{ errorMsg }}</span>
            <button class="btn btn-xs" @click="fetchData">é‡è©¦</button>
        </div>

        <div v-show="!loading && currentTab === 'dashboard'" class="space-y-6">
            
            <div class="card bg-base-200 border border-white/5 shadow-xl">
                <div class="card-body p-4">
                    <h3 class="card-title text-lg mb-2">ğŸ•¸ï¸ èœå–®çµæ§‹åˆ†æ (ä¸»é¡åˆ¥)</h3>
                    <div class="relative w-full h-64 md:h-72 flex justify-center">
                        <canvas id="mainChart"></canvas>
                    </div>
                    <div class="text-center text-xs text-gray-500 mt-2">
                        * é¡¯ç¤ºå„å‹•ä½œæ¨¡å¼ (ä¸»é¡åˆ¥) çš„è¨“ç·´æ¯”é‡
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-center px-1">
                    <h3 class="text-xl font-bold">ğŸ” å¿«é€ŸæŸ¥è©¢</h3>
                    <button v-if="filterCategory" @click="filterCategory=''" class="btn btn-xs btn-ghost text-error">æ¸…é™¤ç¯©é¸ âœ•</button>
                </div>
                
                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                    <button 
                        v-for="cat in uniqueCategories" :key="cat"
                        @click="filterCategory = (filterCategory === cat ? '' : cat)"
                        class="btn btn-sm flex-shrink-0"
                        :class="filterCategory === cat ? 'btn-primary' : 'btn-outline border-white/20'"
                    >
                        {{ cat }}
                    </button>
                </div>

                <div v-if="filterCategory" class="stats shadow w-full bg-base-200 border border-primary/20">
                    <div class="stat p-3">
                        <div class="stat-title text-xs">è©²é¡åˆ¥ç´€éŒ„</div>
                        <div class="stat-value text-xl font-mono">{{ filteredLogs.length }} <span class="text-xs">ç­†</span></div>
                    </div>
                    <div class="stat p-3">
                        <div class="stat-title text-xs">æœ€é«˜å¼·åº¦ (1RM)</div>
                        <div class="stat-value text-xl text-accent font-mono">{{ categoryStats.max1RM }} <span class="text-xs">kg</span></div>
                    </div>
                </div>

                <div class="overflow-x-auto bg-base-200 rounded-xl border border-white/5 max-h-[500px] overflow-y-auto">
                    <table class="table table-pin-rows table-sm w-full">
                        <thead>
                            <tr class="bg-base-300 text-gray-400 sticky top-0">
                                <th>æ—¥æœŸ</th>
                                <th>å‹•ä½œ / é¡åˆ¥</th>
                                <th class="text-right">èœå–®å…§å®¹</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="log in filteredLogs" :key="log.id" class="border-b-white/5 hover:bg-white/5">
                                <td class="font-mono text-xs opacity-70 w-24">{{ log.Date }}</td>
                                <td>
                                    <div class="font-bold text-sm">{{ log.Exercise }}</div>
                                    <span class="badge badge-xs badge-ghost opacity-50">{{ log.MainCategory }}</span>
                                    <div v-if="log.Note" class="text-xs text-warning mt-1">ğŸ“ {{ log.Note }}</div>
                                </td>
                                <td class="text-right font-mono">
                                    <div class="text-lg font-bold text-accent">{{ log.Weight }} <span class="text-xs text-gray-500">kg</span></div>
                                    <div class="text-xs text-gray-400">{{ log.Reps }} reps Ã— {{ log.Sets }} sets</div>
                                </td>
                            </tr>
                            <tr v-if="filteredLogs.length === 0">
                                <td colspan="3" class="text-center py-8 text-gray-500">
                                    ç„¡ç›¸é—œç´€éŒ„
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'tools'" class="max-w-md mx-auto pt-10 px-4">
            <div class="card bg-base-200 shadow-2xl border border-accent">
                <div class="card-body">
                    <h2 class="card-title text-2xl text-accent mb-4">ğŸ§® 1RM è¨ˆç®—æ©Ÿ</h2>
                    <div class="form-control">
                        <label class="label"><span class="label-text">é‡é‡ (Weight)</span></label>
                        <input type="number" v-model="calc.weight" class="input input-bordered input-lg font-mono text-xl" placeholder="kg">
                    </div>
                    <div class="form-control mt-4">
                        <label class="label"><span class="label-text">æ¬¡æ•¸ (Reps)</span></label>
                        <input type="number" v-model="calc.reps" class="input input-bordered input-lg font-mono text-xl" placeholder="reps">
                    </div>
                    <div class="divider">é ä¼°çµæœ</div>
                    <div class="text-center">
                        <div class="text-6xl font-mono font-black text-white">{{ estimated1RM }}</div>
                        <div class="text-sm opacity-50 mt-2">Epley Formula (kg)</div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div class="btm-nav btm-nav-lg bg-base-200 border-t border-white/10 z-40">
        <button :class="currentTab === 'dashboard' ? 'active text-primary' : ''" @click="currentTab = 'dashboard'">
            <span class="text-2xl">ğŸ“Š</span>
            <span class="btm-nav-label text-xs">æ•™ç·´çœ‹æ¿</span>
        </button>
        <button :class="currentTab === 'tools' ? 'active text-accent' : ''" @click="currentTab = 'tools'">
            <span class="text-2xl">ğŸ§®</span>
            <span class="btm-nav-label text-xs">è¨ˆç®—æ©Ÿ</span>
        </button>
    </div>

</div>

<script>
    const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // ğŸš¨ è¨­å®šå€
            const API_URL = 'https://script.google.com/macros/s/AKfycbx2npaR9aZnvMvtkIRsRB1aTJVjuYZElACcqT3hZQZBaTE1ypbs9ewh7q_35T8AB0KdMA/exec';
            const LINE_CALL_URL = 'https://lin.ee/Sh5UgkkJ';

            const loading = ref(true);
            const errorMsg = ref('');
            const rawData = ref([]);
            const currentTab = ref('dashboard');
            
            // ç¯©é¸èˆ‡è¨ˆç®—æ©Ÿ
            const filterCategory = ref(''); // ç•¶å‰é¸ä¸­çš„ä¸»é¡åˆ¥
            const calc = ref({ weight: '', reps: '' });

            const fetchData = async () => {
                loading.value = true; errorMsg.value = '';
                try {
                    const res = await fetch(`${API_URL}${API_URL.includes('?')?'&':'?'}type=json`);
                    const json = await res.json();
                    if (json.status === 'error') throw new Error(json.message);
                    
                    if (json.data) {
                        rawData.value = json.data.map((r, i) => {
                            const mapInfo = (json.mapping && json.mapping[r.exercise]) || {};
                            return {
                                id: i,
                                Date: r.date,
                                Exercise: r.exercise,
                                Weight: Number(r.weight) || 0,
                                Reps: Number(r.reps) || 0,
                                Sets: Number(r.sets) || 0,
                                OneRm: Number(r.oneRm) || 0,
                                Note: r.note,
                                // é—œéµï¼šé€™è£¡æ”¹æŠ“ mainCategory (ä¸»é¡åˆ¥)
                                MainCategory: mapInfo.mainCategory || 'æœªåˆ†é¡', 
                                BodyPart: mapInfo.bodyPart || 'å…¶ä»–'
                            };
                        });
                    }
                } catch (e) {
                    errorMsg.value = `è®€å–å¤±æ•—: ${e.message}`;
                } finally {
                    loading.value = false;
                }
            };

            // å–å¾—æ‰€æœ‰ä¸»é¡åˆ¥ (ç”¨æ–¼æŒ‰éˆ•)
            const uniqueCategories = computed(() => {
                const cats = new Set(rawData.value.map(d => d.MainCategory));
                // ç§»é™¤ 'æœªåˆ†é¡' æ”¾åœ¨æœ€å¾Œï¼Œå…¶ä»–æ’åº
                const arr = Array.from(cats).filter(c => c !== 'æœªåˆ†é¡').sort();
                if (cats.has('æœªåˆ†é¡')) arr.push('æœªåˆ†é¡');
                return arr;
            });

            // ç¯©é¸å¾Œçš„æ—¥èªŒ
            const filteredLogs = computed(() => {
                let logs = rawData.value;
                if (filterCategory.value) {
                    logs = logs.filter(d => d.MainCategory === filterCategory.value);
                }
                // æ’åºï¼šæ–°åˆ°èˆŠ
                return logs.sort((a, b) => new Date(b.Date) - new Date(a.Date));
            });

            // è©²é¡åˆ¥çš„çµ±è¨ˆæ•¸æ“š
            const categoryStats = computed(() => {
                if (!filteredLogs.value.length) return { max1RM: 0 };
                const max = Math.max(...filteredLogs.value.map(d => d.OneRm));
                return { max1RM: max };
            });

            // 1RM è¨ˆç®—
            const estimated1RM = computed(() => {
                const w = parseFloat(calc.value.weight);
                const r = parseFloat(calc.value.reps);
                return (w && r) ? Math.round(w * (1 + r / 30)) : 0;
            });

            // åœ–è¡¨æ¸²æŸ“ (é›·é”åœ– - ä¸»é¡åˆ¥ç‰ˆ)
            let chartInstance = null;
            const renderChart = () => {
                const ctx = document.getElementById('mainChart');
                if (!ctx) return;
                if (chartInstance) chartInstance.destroy();

                // çµ±è¨ˆå„ä¸»é¡åˆ¥çš„ç¸½ Set æ•¸ (åæ˜ èœå–®çµæ§‹)
                const catSets = {};
                rawData.value.forEach(d => {
                    const c = d.MainCategory;
                    if (!catSets[c]) catSets[c] = 0;
                    catSets[c] += d.Sets;
                });

                chartInstance = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: Object.keys(catSets),
                        datasets: [{
                            label: 'ç¸½çµ„æ•¸åˆ†ä½ˆ',
                            data: Object.values(catSets),
                            backgroundColor: 'rgba(56, 189, 248, 0.4)', // Sky Blue
                            borderColor: '#38BDF8',
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#38BDF8'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                angleLines: { color: 'rgba(255,255,255,0.1)' },
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                pointLabels: { color: '#fff', font: { size: 13, weight: 'bold' } },
                                ticks: { display: false, backdropColor: 'transparent' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            };

            watch(loading, (val) => { if(!val) nextTick(renderChart); });
            watch(currentTab, (val) => { if(val==='dashboard') nextTick(renderChart); });

            onMounted(fetchData);

            return {
                loading, errorMsg, rawData, currentTab, 
                filterCategory, uniqueCategories, filteredLogs, categoryStats,
                calc, estimated1RM, lineCallUrl: LINE_CALL_URL
            };
        }
    }).mount('#app');
</script>
</body>
</html>