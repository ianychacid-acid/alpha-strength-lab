<!DOCTYPE html>
<html lang="zh-TW" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alpha Strength Console v2.1</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’ª</text></svg>">

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- V2.1 UI/UX æ ¸å¿ƒå„ªåŒ– --- */
        body {
            font-family: 'Inter', sans-serif;
            font-size: 16px; /* Mobile åŸºç¤å­—è™Ÿæå‡ */
            background-color: #0F172A; /* å¼·åˆ¶æ·±è‰²èƒŒæ™¯ */
            color: #E2E8F0;
        }
        @media (min-width: 768px) {
            body {
                font-size: 18px; /* PC åŸºç¤å­—è™Ÿå¤§å¹…æå‡ */
            }
        }
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -0.5px;
        }
        button, .btn {
            touch-action: manipulation; /* è§£æ±º iOS é»æ“Šå»¶é² */
        }
        .card {
            border: 1px solid rgba(255,255,255,0.1);
        }
        /* Loading å‹•ç•« */
        .loading-overlay {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="bg-base-100 text-base-content min-h-screen flex flex-col">

<div id="app" class="flex flex-col h-screen overflow-hidden">

    <div class="navbar bg-base-200 border-b border-base-300 px-4 py-3 shadow-lg z-20">
        <div class="flex-1">
            <a class="btn btn-ghost normal-case text-xl md:text-2xl font-extrabold tracking-tight text-primary">
                Alpha<span class="text-white">Strength</span>
                <span class="badge badge-primary badge-outline ml-2 text-xs align-top">v2.1</span>
            </a>
        </div>
        <div class="flex-none gap-2">
            <div class="join">
                <button 
                    class="btn btn-sm md:btn-md join-item" 
                    :class="currentView === 'dashboard' ? 'btn-primary' : 'btn-ghost'"
                    @click="currentView = 'dashboard'">
                    ğŸ“Š <span class="hidden md:inline">çœ‹æ¿</span>
                </button>
                <button 
                    class="btn btn-sm md:btn-md join-item" 
                    :class="currentView === 'calculator' ? 'btn-accent' : 'btn-ghost'"
                    @click="currentView = 'calculator'">
                    ğŸ§® <span class="hidden md:inline">1RM</span>
                </button>
            </div>
        </div>
    </div>

    <main class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth" ref="mainContainer">
        
        <div v-if="loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center loading-overlay">
            <span class="loading loading-ring loading-lg text-primary scale-150"></span>
            <p class="mt-4 text-lg md:text-xl font-bold animate-pulse text-gray-300">æ•¸æ“šåŒæ­¥ä¸­...</p>
        </div>

        <div v-if="errorMsg" class="alert alert-error shadow-lg mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span>{{ errorMsg }}</span>
            <button class="btn btn-sm btn-ghost" @click="fetchData">é‡è©¦</button>
        </div>

        <div v-show="currentView === 'dashboard'" class="max-w-7xl mx-auto space-y-6 md:space-y-8">
            
            <div class="flex flex-col md:flex-row gap-4">
                <div class="form-control flex-1">
                    <input type="text" v-model="searchQuery" placeholder="ğŸ” æœå°‹å‹•ä½œ (å¦‚: æ·±è¹²)..." class="input input-bordered w-full text-lg h-12 md:h-14" />
                </div>
                <select v-model="selectedCategory" class="select select-bordered w-full md:w-auto text-lg h-12 md:h-14">
                    <option value="">ğŸ“ æ‰€æœ‰éƒ¨ä½</option>
                    <option v-for="cat in uniqueCategories" :key="cat" :value="cat">{{ cat }}</option>
                </select>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                <div class="stat bg-base-200 rounded-box shadow-sm border border-base-300 p-4">
                    <div class="stat-title font-bold opacity-70">ç¸½è¨“ç·´é‡</div>
                    <div class="stat-value text-primary text-2xl md:text-4xl font-mono">{{ stats.totalVolume }}</div>
                    <div class="stat-desc">ç´¯ç©å™¸æ•¸</div>
                </div>
                <div class="stat bg-base-200 rounded-box shadow-sm border border-base-300 p-4">
                    <div class="stat-title font-bold opacity-70">ç¸½çµ„æ•¸</div>
                    <div class="stat-value text-secondary text-2xl md:text-4xl font-mono">{{ stats.totalSets }}</div>
                    <div class="stat-desc">ç´¯ç©æ¬¡æ•¸</div>
                </div>
                <div class="stat bg-base-200 rounded-box shadow-sm border border-base-300 p-4">
                    <div class="stat-title font-bold opacity-70">æœ€è¿‘è¨“ç·´</div>
                    <div class="stat-value text-accent text-lg md:text-2xl font-mono">{{ stats.lastDate }}</div>
                    <div class="stat-desc">{{ stats.daysSince }} å¤©å‰</div>
                </div>
                <div class="stat bg-base-200 rounded-box shadow-sm border border-base-300 p-4">
                    <div class="stat-title font-bold opacity-70">æœ¬é€±é »ç‡</div>
                    <div class="stat-value text-2xl md:text-4xl font-mono">{{ stats.weeklyFreq }}</div>
                    <div class="stat-desc">æ¬¡ / é€±</div>
                </div>
            </div>

            <div class="card bg-base-200 shadow-xl border border-base-300">
                <div class="card-body p-4 md:p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="card-title text-xl md:text-2xl">ğŸ“ˆ è¨“ç·´è¶¨å‹¢</h2>
                        <div class="btn-group">
                            <button class="btn btn-sm md:btn-md" :class="chartMode==='volume' ? 'btn-active btn-primary' : ''" @click="setChartMode('volume')">å®¹é‡</button>
                            <button class="btn btn-sm md:btn-md" :class="chartMode==='max_weight' ? 'btn-active btn-secondary' : ''" @click="setChartMode('max_weight')">å¼·åº¦</button>
                        </div>
                    </div>
                    <div class="relative w-full h-72 md:h-96">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h2 class="text-xl md:text-2xl font-bold px-1">ğŸ“ è©³ç´°è¨˜éŒ„</h2>
                <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                    <div v-for="(item, index) in filteredList" :key="index" 
                         class="card bg-base-200 shadow-md border-l-4 border-primary hover:bg-base-300 transition-colors cursor-pointer"
                         @click="openEditModal(item)">
                        <div class="card-body p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="card-title text-lg md:text-xl text-primary font-bold mb-1">{{ item.Exercise }}</h3>
                                    <p class="text-sm text-gray-400 font-mono">{{ item.Date }}</p>
                                </div>
                                <div class="badge badge-outline badge-lg">{{ item.BodyPart || 'æœªåˆ†é¡' }}</div>
                            </div>
                            <div class="divider my-2"></div>
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div>
                                    <div class="text-xs opacity-60">é‡é‡</div>
                                    <div class="font-mono text-lg font-bold">{{ item.Weight }} <span class="text-xs">kg</span></div>
                                </div>
                                <div>
                                    <div class="text-xs opacity-60">æ¬¡æ•¸</div>
                                    <div class="font-mono text-lg font-bold">{{ item.Reps }}</div>
                                </div>
                                <div>
                                    <div class="text-xs opacity-60">çµ„æ•¸</div>
                                    <div class="font-mono text-lg font-bold">{{ item.Sets }}</div>
                                </div>
                            </div>
                            <div v-if="item.Note" class="mt-3 p-2 bg-base-100 rounded text-sm text-gray-300">
                                ğŸ’¡ {{ item.Note }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-show="currentView === 'calculator'" class="max-w-2xl mx-auto py-8">
            <div class="card bg-base-200 shadow-xl border border-accent">
                <div class="card-body">
                    <h2 class="card-title text-2xl md:text-3xl text-accent mb-6">ğŸ§® 1RM é ä¼°è¨ˆç®—æ©Ÿ</h2>
                    <div class="form-control w-full mb-4">
                        <label class="label"><span class="label-text text-lg">é‡é‡ (kg)</span></label>
                        <input type="number" v-model.number="calcWeight" placeholder="0" class="input input-bordered input-lg text-xl font-mono" />
                    </div>
                    <div class="form-control w-full mb-6">
                        <label class="label"><span class="label-text text-lg">æ¬¡æ•¸ (Reps)</span></label>
                        <input type="number" v-model.number="calcReps" placeholder="0" class="input input-bordered input-lg text-xl font-mono" />
                    </div>
                    <div class="divider">çµæœ</div>
                    <div class="stats shadow w-full bg-base-100">
                        <div class="stat place-items-center">
                            <div class="stat-title text-lg">é ä¼° 1RM</div>
                            <div class="stat-value text-accent text-5xl font-mono my-2">{{ calculated1RM }}</div>
                            <div class="stat-desc">kg (Epley Formula)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <dialog class="modal modal-bottom sm:modal-middle" :class="{ 'modal-open': showModal }">
        <div class="modal-box bg-base-200">
            <h3 class="font-bold text-xl mb-4 text-primary">ç·¨è¼¯å‹•ä½œ</h3>
            <p class="py-2 text-lg font-bold">{{ editingItem.exercise }}</p>
            <div class="form-control w-full mt-4">
                <label class="label"><span class="label-text">éƒ¨ä½åˆ†é¡</span></label>
                <select class="select select-bordered text-lg" v-model="editingItem.newBodyPart">
                    <option value="èƒ¸">èƒ¸</option><option value="èƒŒ">èƒŒ</option><option value="è…¿">è…¿</option>
                    <option value="è‚©">è‚©</option><option value="æ ¸å¿ƒ">æ ¸å¿ƒ</option><option value="å…¨èº«">å…¨èº«</option><option value="æœ‰æ°§">æœ‰æ°§</option>
                </select>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost text-lg" @click="showModal = false">å–æ¶ˆ</button>
                <button class="btn btn-primary text-lg" @click="saveCategory" :disabled="saving">
                    {{ saving ? 'å„²å­˜ä¸­...' : 'ç¢ºèª' }}
                </button>
            </div>
        </div>
    </dialog>

</div>

<script>
    const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // ğŸš¨ é‡è¦ï¼šè«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨éƒ¨ç½²å¾Œçš„æ–° GAS ç¶²å€
            const API_URL = 'https://script.google.com/macros/s/AKfycbx2npaR9aZnvMvtkIRsRB1aTJVjuYZElACcqT3hZQZBaTE1ypbs9ewh7q_35T8AB0KdMA/exec'; 

            const loading = ref(true);
            const errorMsg = ref('');
            const rawData = ref([]);
            const mapping = ref({});
            const currentView = ref('dashboard');
            
            // æœå°‹èˆ‡ç¯©é¸
            const searchQuery = ref('');
            const selectedCategory = ref('');
            
            // åœ–è¡¨è¨­å®š
            const chartMode = ref('volume'); 
            let chartInstance = null;

            // ç·¨è¼¯èˆ‡è¨ˆç®—æ©Ÿ
            const showModal = ref(false);
            const editingItem = ref({ exercise: '', newBodyPart: '', newNote: '' });
            const saving = ref(false);
            const calcWeight = ref('');
            const calcReps = ref('');

            // --- æ ¸å¿ƒé‚è¼¯ï¼šæ•¸æ“šç²å–èˆ‡è½‰æ¥ ---
            const fetchData = async () => {
                loading.value = true;
                errorMsg.value = '';
                try {
                    // å¼·åˆ¶åŠ å…¥ type=json åƒæ•¸
                    const targetUrl = API_URL + (API_URL.includes('?') ? '&' : '?') + 'type=json';
                    
                    const res = await fetch(targetUrl);
                    const json = await res.json(); 

                    if (json.status === 'error') {
                        throw new Error(json.message);
                    }

                    // ğŸ› ï¸ é—œéµä¿®æ­£ï¼šå°‡å¾Œç«¯çš„å°å¯«æ¬„ä½ (date) è½‰æ›ç‚ºå‰ç«¯çš„å¤§å¯«æ¬„ä½ (Date)
                    if (json.data) {
                        rawData.value = json.data.map(row => ({
                            Date: row.date,        // è½‰æ¥: date -> Date
                            UserId: row.userId,
                            Exercise: row.exercise,// è½‰æ¥: exercise -> Exercise
                            Weight: row.weight,
                            Reps: row.reps,
                            Sets: row.sets,
                            OneRm: row.oneRm,
                            Video_Link: row.videoLink,
                            Note: row.note,
                            // é ç•™æ¬„ä½
                            BodyPart: '', 
                            Category: ''
                        }));
                    }

                    if (json.mapping) mapping.value = json.mapping;

                    // åˆä½µ Mapping è³‡è¨Š (è£œä¸Šéƒ¨ä½èˆ‡å‚™è¨»)
                    rawData.value.forEach(item => {
                        const mapInfo = mapping.value[item.Exercise] || {};
                        item.BodyPart = mapInfo.bodyPart || 'æœªåˆ†é¡';
                        if (!item.Note && mapInfo.note) item.Note = mapInfo.note; 
                    });

                } catch (e) {
                    console.error("Fetch Error:", e);
                    errorMsg.value = "ç„¡æ³•è®€å–æ•¸æ“šï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è¯ç¹«ç¸½ç›£ã€‚(" + e.message + ")";
                } finally {
                    loading.value = false;
                }
            };

            // --- è¨ˆç®—å±¬æ€§ (é˜²å‘†ä¿è­·ç‰ˆ) ---
            const uniqueCategories = computed(() => {
                const cats = new Set(rawData.value.map(i => i.BodyPart).filter(Boolean));
                return Array.from(cats).sort();
            });

            const filteredList = computed(() => {
                let list = rawData.value;
                if (!Array.isArray(list)) return [];

                if (selectedCategory.value) {
                    list = list.filter(i => i.BodyPart === selectedCategory.value);
                }
                if (searchQuery.value) {
                    const q = searchQuery.value.toLowerCase();
                    list = list.filter(i => 
                        (i.Exercise && String(i.Exercise).toLowerCase().includes(q)) ||
                        (i.Note && String(i.Note).toLowerCase().includes(q))
                    );
                }
                return list.sort((a, b) => new Date(b.Date) - new Date(a.Date));
            });

            const stats = computed(() => {
                if (filteredList.value.length === 0) return { totalVolume: 0, totalSets: 0, lastDate: '-', daysSince: 0, weeklyFreq: 0 };
                const list = filteredList.value;
                
                // è¨ˆç®—ç¸½é‡
                const totalVolume = list.reduce((acc, cur) => acc + (parseFloat(cur.Weight||0) * parseFloat(cur.Reps||0) * parseFloat(cur.Sets||0)), 0);
                const totalSets = list.reduce((acc, cur) => acc + parseFloat(cur.Sets||0), 0);
                
                // æ—¥æœŸè¨ˆç®— (åŠ å…¥é˜²å‘†ï¼Œé¿å… split å ±éŒ¯)
                const lastItem = list[0];
                const lastDateStr = lastItem && lastItem.Date ? lastItem.Date : new Date().toISOString();
                const lastDateObj = new Date(lastDateStr);
                
                const daysSince = Math.floor((new Date() - lastDateObj) / (1000 * 60 * 60 * 24));

                // é€±é »ç‡
                const firstItem = list[list.length-1];
                const firstDateStr = firstItem && firstItem.Date ? firstItem.Date : new Date().toISOString();
                const weeks = Math.max(1, (new Date() - new Date(firstDateStr)) / (1000 * 60 * 60 * 24 * 7));
                
                const uniqueDays = new Set(list.map(i => (i.Date ? String(i.Date).split('T')[0] : '')));
                uniqueDays.delete('');
                
                return {
                    totalVolume: Math.round(totalVolume / 1000) + 'k',
                    totalSets,
                    lastDate: lastDateObj.toLocaleDateString(),
                    daysSince,
                    weeklyFreq: (uniqueDays.size / weeks).toFixed(1)
                };
            });

            const calculated1RM = computed(() => {
                const w = parseFloat(calcWeight.value);
                const r = parseFloat(calcReps.value);
                if (!w || !r) return 0;
                return (w * (1 + r / 30)).toFixed(1);
            });

            // --- åœ–è¡¨é‚è¼¯ (V2.1 ä¿®å¾©ç‰ˆ) ---
            const initCharts = () => {
                const ctx = document.getElementById('mainChart');
                if (!ctx) return;
                if (chartInstance) chartInstance.destroy();

                const dateMap = {};
                // åè½‰åˆ—è¡¨ (èˆŠ -> æ–°)
                [...filteredList.value].reverse().forEach(item => {
                    if (!item.Date) return;
                    const d = String(item.Date).split('T')[0];
                    
                    if (!dateMap[d]) dateMap[d] = { vol: 0, maxW: 0, exercises: [] };
                    
                    const vol = (parseFloat(item.Weight)||0) * (parseFloat(item.Reps)||0) * (parseFloat(item.Sets)||0);
                    dateMap[d].vol += vol;
                    
                    const w = parseFloat(item.Weight) || 0;
                    if (w > dateMap[d].maxW) dateMap[d].maxW = w;

                    if (!dateMap[d].exercises.includes(item.Exercise)) {
                        dateMap[d].exercises.push(item.Exercise);
                    }
                });

                const labels = Object.keys(dateMap);
                const dataPoints = labels.map(d => chartMode.value === 'volume' ? dateMap[d].vol : dateMap[d].maxW);

                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: chartMode.value === 'volume' ? 'è¨“ç·´å®¹é‡ (kg)' : 'æœ€å¤§å¼·åº¦ (kg)',
                            data: dataPoints,
                            borderColor: chartMode.value === 'volume' ? '#66CC8A' : '#D926A9',
                            backgroundColor: chartMode.value === 'volume' ? 'rgba(102, 204, 138, 0.1)' : 'rgba(217, 38, 169, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHitRadius: 20
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { labels: { color: '#A6ADBB' } },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                callbacks: {
                                    // V2.1 å„ªåŒ–ï¼šé¡¯ç¤ºå…·é«”å‹•ä½œ
                                    afterLabel: function(context) {
                                        const date = labels[context.dataIndex];
                                        const ex = dateMap[date].exercises.slice(0, 3).join(', ');
                                        return 'åŒ…å«: ' + ex + (dateMap[date].exercises.length > 3 ? '...' : '');
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#A6ADBB' } },
                            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#A6ADBB' } }
                        }
                    }
                });
            };

            // --- ç›£è½å™¨ ---
            watch(loading, (newVal) => { if (!newVal) nextTick(initCharts); });
            watch([currentView, selectedCategory, chartMode, searchQuery], () => { 
                if (currentView.value === 'dashboard') nextTick(initCharts); 
            });

            // ç·¨è¼¯åŠŸèƒ½
            const openEditModal = (item) => {
                editingItem.value = {
                    exercise: item.Exercise,
                    newBodyPart: item.BodyPart || '',
                    newNote: item.Note || ''
                };
                showModal.value = true;
            };

            const saveCategory = async () => {
                saving.value = true;
                const item = rawData.value.find(i => i.Exercise === editingItem.value.exercise);
                if (item) item.BodyPart = editingItem.value.newBodyPart;
                
                if (!mapping.value[editingItem.value.exercise]) mapping.value[editingItem.value.exercise] = {};
                mapping.value[editingItem.value.exercise].bodyPart = editingItem.value.newBodyPart;

                // å¯¦éš›å°ˆæ¡ˆæ‡‰åœ¨æ­¤è™•ç™¼é€ POST æ›´æ–°åˆ° GAS (Mapping update)
                setTimeout(() => {
                    saving.value = false;
                    showModal.value = false;
                }, 500);
            };

            const setChartMode = (mode) => chartMode.value = mode;

            onMounted(() => {
                fetchData();
            });

            return {
                loading, errorMsg, stats, filteredList, uniqueCategories,
                currentView, searchQuery, selectedCategory, chartMode, setChartMode,
                calcWeight, calcReps, calculated1RM,
                showModal, editingItem, openEditModal, saveCategory, saving
            };
        }
    }).mount('#app');
</script>

</body>
</html>