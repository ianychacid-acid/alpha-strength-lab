<!DOCTYPE html>
<html lang="zh-TW" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alpha Strength Lab v2.0 | Director's Console</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* è‡ªå®šç¾© Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* å‹•ç•«éæ¸¡ */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* æ‰‹æ©Ÿç‰ˆåº•éƒ¨å®‰å…¨å€ä¿®æ­£ */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="min-h-screen text-base-content overflow-hidden">

<div id="app" class="flex h-screen bg-base-300">
    
    <div v-if="loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-base-300/90 backdrop-blur">
        <span class="loading loading-infinity loading-lg text-primary"></span>
        <p class="mt-4 text-sm font-mono text-base-content/60 animate-pulse">Initializing System...</p>
    </div>

    <aside class="hidden md:flex flex-col w-64 bg-base-200 border-r border-base-content/5 h-full">
        <div class="p-6">
            <h1 class="text-2xl font-black tracking-tighter text-primary">ALPHA <span class="text-base-content">LAB</span></h1>
            <p class="text-xs text-base-content/50 font-mono mt-1">v2.0 // ARCHITECT</p>
        </div>
        
        <nav class="flex-1 px-4 space-y-2">
            <button @click="currentView = 'dashboard'" :class="{'btn-primary': currentView === 'dashboard', 'btn-ghost': currentView !== 'dashboard'}" class="btn btn-block justify-start gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                ç¸½è¦½å„€è¡¨æ¿
            </button>
            <button @click="currentView = 'analytics'" :class="{'btn-primary': currentView === 'analytics', 'btn-ghost': currentView !== 'analytics'}" class="btn btn-block justify-start gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                æ·±åº¦åˆ†æ
            </button>
            <button @click="currentView = 'logs'" :class="{'btn-primary': currentView === 'logs', 'btn-ghost': currentView !== 'logs'}" class="btn btn-block justify-start gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                è¨“ç·´æ—¥èªŒ
            </button>
        </nav>

        <div class="p-4 border-t border-base-content/5">
            <div class="alert alert-info text-xs py-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span v-if="isDemoMode">DEMO æ¨¡å¼ (é›¢ç·š)</span>
                <span v-else>ç³»çµ±é€£ç·šæ­£å¸¸</span>
            </div>
        </div>
    </aside>
<main class="flex-1 flex flex-col h-full overflow-hidden relative">
        
        <header class="md:hidden navbar bg-base-100 border-b border-base-content/10 z-10 shrink-0">
            <div class="flex-1">
                <a class="btn btn-ghost normal-case text-xl font-black text-primary">ALPHA LAB</a>
            </div>
            <div class="flex-none">
                <button @click="fetchData(true)" class="btn btn-square btn-ghost btn-sm">
                    <span v-if="loading" class="loading loading-spinner loading-xs"></span>
                    <span v-else>ğŸ”„</span>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-24 md:pb-8 scroll-smooth">
            
            <div v-if="currentView === 'dashboard'" class="space-y-6 fade-enter-active">
                <div class="flex justify-between items-end">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Console Overview</h2>
                        <p class="text-base-content/60">ä»Šå¤©çš„è¨“ç·´æ•¸æ“šæ‘˜è¦</p>
                    </div>
                    <button @click="currentView='logs'" class="btn btn-sm btn-outline md:hidden">æŸ¥çœ‹æ‰€æœ‰ç´€éŒ„</button>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="stat bg-base-200 rounded-box shadow">
                        <div class="stat-figure text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                        <div class="stat-title">ç¸½è¨“ç·´æ¬¡æ•¸</div>
                        <div class="stat-value text-primary">{{ stats.totalLogs }}</div>
                        <div class="stat-desc">ç´¯è¨ˆè³‡æ–™ç­†æ•¸</div>
                    </div>
                    
                    <div class="stat bg-base-200 rounded-box shadow">
                        <div class="stat-figure text-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        </div>
                        <div class="stat-title">æ¶µè“‹å‹•ä½œ</div>
                        <div class="stat-value text-secondary">{{ stats.uniqueExercises }}</div>
                        <div class="stat-desc">ç¨®ä¸åŒè¨“ç·´é …ç›®</div>
                    </div>
                    
                    <div class="stat bg-base-200 rounded-box shadow col-span-2 md:col-span-2">
                        <div class="stat-figure text-accent">
                            <div class="avatar online">
                                <div class="w-12 rounded-full ring ring-accent ring-offset-base-100 ring-offset-2">
                                    <span class="text-xl font-bold flex items-center justify-center h-full bg-neutral text-neutral-content">A</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-title">ä¸Šæ¬¡è¨“ç·´</div>
                        <div class="stat-value text-2xl md:text-3xl">{{ stats.lastDate }}</div>
                        <div class="stat-desc text-accent">ç³»çµ±ç‹€æ…‹ï¼šOnline</div>
                    </div>
                </div>

                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body p-4 md:p-6">
                        <h3 class="card-title text-sm opacity-70 mb-4">è¨“ç·´éƒ¨ä½åˆ†ä½ˆ (Body Part Radar)</h3>
                        <div class="h-64 md:h-80 relative flex justify-center">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'analytics'" class="space-y-6 fade-enter-active">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <h2 class="text-2xl font-bold">æ·±åº¦åˆ†æ</h2>
                    <select v-model="selectedCategory" class="select select-bordered select-sm w-full md:w-auto max-w-xs">
                        <option value="ALL">å…¨éƒ¨é¡åˆ¥ (All Categories)</option>
                        <option v-for="cat in uniqueCategories" :value="cat">{{ cat }}</option>
                    </select>
                </div>

                <div class="card bg-base-200 shadow-xl w-full">
                    <div class="card-body p-2 md:p-6">
                        <div class="flex justify-between items-center mb-4 px-2">
                            <h3 class="font-bold">å¼·åº¦è¶¨å‹¢åœ–</h3>
                            <div class="join">
                                <button @click="chartMode = 'max'" class="join-item btn btn-xs" :class="{'btn-active btn-primary': chartMode==='max'}">æœ€å¤§é‡é‡</button>
                                <button @click="chartMode = 'vol'" class="join-item btn btn-xs" :class="{'btn-active btn-secondary': chartMode==='vol'}">ç¸½å®¹é‡</button>
                            </div>
                        </div>
                        <div class="h-[300px] md:h-[400px] w-full relative">
                            <canvas id="workoutChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'logs'" class="space-y-4 fade-enter-active">
                <div class="sticky top-0 bg-base-300 pt-2 pb-4 z-10 flex gap-2">
                    <input v-model="searchQuery" type="text" placeholder="æœå°‹å‹•ä½œåç¨±..." class="input input-bordered input-sm w-full" />
                </div>

                <div class="grid gap-3">
                    <div v-for="(log, index) in filteredList" :key="index" class="card bg-base-200 shadow-sm border-l-4 border-primary hover:bg-base-100 transition-colors">
                        <div class="card-body p-4 flex flex-row justify-between items-center">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="font-bold truncate text-lg text-white">{{ log.exercise }}</h3>
                                    <span v-if="log.userId" class="badge badge-xs badge-ghost opacity-60">@{{ log.userId }}</span>
                                    <span v-if="log.category !== 'æœªåˆ†é¡'" class="badge badge-xs badge-outline opacity-70">{{ log.category }}</span>
                                    <a v-if="log.videoLink" :href="log.videoLink" target="_blank" class="text-xs text-info hover:text-primary transition-colors">ğŸ”— å½±ç‰‡</a>
                                </div>
                                <p class="text-xs text-base-content/60 font-mono">{{ log.date }}</p>
                            </div>
                            <div class="text-right pl-4">
                                <div class="font-mono text-xl font-bold text-primary">{{ log.weightVal }} <span class="text-xs font-normal opacity-50">kg</span></div>
                                <div class="text-xs opacity-60">{{ log.sets }} x {{ log.reps }}</div>
                            </div>
                            <div class="ml-4">
                                <button @click="openEditModal(log)" class="btn btn-ghost btn-xs btn-circle text-info">
                                    âœï¸
                                </button>
                            </div>
                        </div>
                    </div>
                    <div v-if="filteredList.length === 0" class="text-center py-10 opacity-50">
                        <p>æ²’æœ‰ç¬¦åˆçš„ç´€éŒ„</p>
                    </div>
                </div>
            </div>

        </div> <div class="md:hidden btm-nav bg-base-200 border-t border-base-content/10 pb-safe z-40">
            <button @click="currentView = 'dashboard'" :class="{'active text-primary': currentView === 'dashboard'}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                <span class="btm-nav-label text-xs">ç¸½è¦½</span>
            </button>
            <button @click="currentView = 'analytics'" :class="{'active text-primary': currentView === 'analytics'}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                <span class="btm-nav-label text-xs">åˆ†æ</span>
            </button>
            <button @click="currentView = 'logs'" :class="{'active text-primary': currentView === 'logs'}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <span class="btm-nav-label text-xs">æ—¥èªŒ</span>
            </button>
        </div>

    </main>

    <dialog class="modal modal-bottom sm:modal-middle backdrop-blur-sm" :class="{'modal-open': showModal}">
        <div class="modal-box bg-base-200 border border-base-content/10">
            <h3 class="font-bold text-lg mb-4">ğŸ”§ ä¿®æ­£å‹•ä½œåˆ†é¡</h3>
            
            <div class="form-control w-full">
                <label class="label"><span class="label-text">å‹•ä½œåç¨±</span></label>
                <input type="text" :value="editingItem.exercise" disabled class="input input-bordered w-full opacity-60" />
            </div>

            <div class="form-control w-full mt-3">
                <label class="label"><span class="label-text">ä¸»é¡åˆ¥ (Category)</span></label>
                <input v-model="editingItem.newCategory" type="text" placeholder="ä¾‹å¦‚ï¼šèƒ¸ã€èƒŒã€è…¿..." class="input input-bordered w-full" />
                <label class="label"><span class="label-text-alt text-base-content/50">å»ºè­°çµ±ä¸€æ ¼å¼ä»¥åˆ©åœ–è¡¨åˆ†æ</span></label>
            </div>

            <div class="form-control w-full mt-2">
                <label class="label"><span class="label-text">éƒ¨ä½ (Body Part)</span></label>
                <input v-model="editingItem.newBodyPart" type="text" placeholder="ä¾‹å¦‚ï¼šä¸Šèƒ¸ã€äºŒé ­è‚Œ..." class="input input-bordered w-full" />
            </div>
            
            <div class="form-control w-full mt-2">
                <label class="label"><span class="label-text">å‚™è¨»/å½±ç‰‡é€£çµ (Mapping Note)</span></label>
                <input v-model="editingItem.newNote" type="text" placeholder="ä¾‹å¦‚ï¼šé€™æ˜¯æˆ‘çš„ PR å‚™è¨»" class="input input-bordered w-full" />
            </div>

            <div class="modal-action">
                <button @click="showModal = false" class="btn btn-ghost">å–æ¶ˆ</button>
                <button @click="saveCategory" class="btn btn-primary" :disabled="saving">
                    <span v-if="saving" class="loading loading-spinner"></span>
                    <span v-else>ç¢ºèªå„²å­˜</span>
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button @click="showModal = false">close</button>
        </form>
    </dialog>

</div> 

<script>
const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

createApp({
    setup() {
        // --- [CONFIG] è¨­å®šå€ ---
        // ğŸ”´ è«‹å‹™å¿…å°‡ä¸‹æ–¹çš„ URL æ›æˆæ‚¨æœ€æ–°éƒ¨ç½²çš„ GAS Web App ç¶²å€ ğŸ”´
        const API_URL = "https://script.google.com/macros/s/AKfycbz0ILttu19iGx4jU4R3HvE-2tlOyEIzp0vRkdeSa_asKwRrJqmpTZEWop3ZNnLnvSuy4A/exec"; 

        // --- [STATE] ç‹€æ…‹è®Šæ•¸ ---
        const loading = ref(true);
        const isDemoMode = ref(false); 
        const logs = ref([]);
        const mapping = ref({});
        const currentView = ref('dashboard'); 
        const searchQuery = ref("");
        const selectedCategory = ref("ALL");
        const chartMode = ref("max"); // 'max' or 'vol'
        
        // Modal ç›¸é—œ
        const showModal = ref(false);
        const editingItem = ref({ exercise: "", newCategory: "", newBodyPart: "", newNote: "" });
        const saving = ref(false);

        // Chart å¯¦ä¾‹ (ç”¨æ–¼éŠ·æ¯€é‡ç¹ª)
        let lineChartInstance = null;
        let radarChartInstance = null;

        // --- [MOCK DATA] æ¨¡æ“¬æ•¸æ“š (2024å¹´ç‰ˆ) ---
        const loadMockData = () => {
            console.warn("âš ï¸ é€£ç·šå¤±æ•—æˆ–é›¢ç·šï¼Œè¼‰å…¥ Mock Data");
            isDemoMode.value = true;
            
            mapping.value = {
                "æ·±è¹²": { category: "è…¿éƒ¨", bodyPart: "è‚¡å››é ­" },
                "ç¡¬èˆ‰": { category: "èƒŒéƒ¨", bodyPart: "ä¸‹èƒŒ" },
                "è‡¥æ¨": { category: "èƒ¸éƒ¨", bodyPart: "ä¸­èƒ¸" },
                "è‚©æ¨": { category: "è‚©éƒ¨", bodyPart: "å‰æŸ" },
                "å¼•é«”å‘ä¸Š": { category: "èƒŒéƒ¨", bodyPart: "èƒŒé—Šè‚Œ" }
            };
            
            logs.value = [
                { date: "2024/07/01", userId: "Director", exercise: "æ·±è¹²", weight: "105", sets: "5", reps: "5", videoLink: "" },
                { date: "2024/07/03", userId: "Director", exercise: "è‡¥æ¨", weight: "82.5", sets: "5", reps: "5", videoLink: "" },
                { date: "2024/07/05", userId: "Andy", exercise: "ç¡¬èˆ‰", weight: "135", sets: "3", reps: "5", videoLink: "https://drive.google.com/link1" },
                { date: "2024/07/08", userId: "Andy", exercise: "å¼•é«”å‘ä¸Š", weight: "0", sets: "4", reps: "8", videoLink: "" },
                { date: "2024/07/10", userId: "Director", exercise: "æ·±è¹²", weight: "110", sets: "5", reps: "5", videoLink: "" },
                { date: "2024/07/12", userId: "Director", exercise: "è‚©æ¨", weight: "55", sets: "4", reps: "8", videoLink: "" },
                { date: "2024/07/15", userId: "Director", exercise: "è‡¥æ¨", weight: "85", sets: "5", reps: "5", videoLink: "" },
                { date: "2024/07/17", userId: "Andy", exercise: "ç¡¬èˆ‰", weight: "140", sets: "1", reps: "5", videoLink: "https://drive.google.com/link2" },
                { date: "2024/07/20", userId: "Director", exercise: "æ·±è¹²", weight: "115", sets: "3", reps: "3", videoLink: "" },
            ]; 
        };

        // --- [CORE] æ ¸å¿ƒåŠŸèƒ½ ---
        const fetchData = async (force = false) => {
            loadMockData(); // å…ˆè¼‰å…¥ Mock é˜²æ­¢ç©ºç™½
            
            if (!force && !isDemoMode.value) { 
                loading.value = false;
                return; 
            }

            loading.value = true;
            isDemoMode.value = false; 

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(`${API_URL}?action=getData`, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

                const data = await response.json();
                
                if (data.status === "success") {
                    logs.value = data.logs;
                    mapping.value = data.mapping;
                    isDemoMode.value = false;
                    console.log("âœ… é€£ç·šæˆåŠŸ");
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error("âŒ é€£ç·šå¤±æ•—ï¼Œåˆ‡æ›è‡³ DEMO:", error);
                isDemoMode.value = true; 
            } finally {
                loading.value = false;
                nextTick(() => initCharts()); 
            }
        };

        // æ•¸æ“šè¨ˆç®—
        const enrichedLogs = computed(() => {
            return logs.value.map(log => {
                const config = mapping.value[log.exercise] || { category: "æœªåˆ†é¡", bodyPart: "æœªçŸ¥", note: "" };
                let w = parseFloat((log.weight || "0").toString().replace(/[^0-9.]/g, '')) || 0;
                return {
                    ...log,
                    weightVal: w,
                    category: config.category || "æœªåˆ†é¡",
                    bodyPart: config.bodyPart || "æœªçŸ¥",
                    noteVal: config.note,
                    userId: log.userId,
                    videoLink: log.videoLink
                };
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
        });

        const filteredList = computed(() => {
            let data = enrichedLogs.value;
            if (searchQuery.value) {
                const q = searchQuery.value.toLowerCase();
                data = data.filter(l => l.exercise.toLowerCase().includes(q));
            }
            return data;
        });

        const stats = computed(() => {
            const data = enrichedLogs.value;
            if (data.length === 0) return { totalLogs: 0, lastDate: "-", uniqueExercises: 0 };
            return {
                totalLogs: data.length,
                lastDate: data[0]?.date || "-",
                uniqueExercises: new Set(data.map(l => l.exercise)).size
            };
        });

        const uniqueCategories = computed(() => {
            const cats = new Set(Object.values(mapping.value).map(m => m.category));
            return Array.from(cats).filter(c => c && c !== "æœªåˆ†é¡").sort();
        });

        // --- [CHART] åœ–è¡¨ç¹ªè£½é‚è¼¯ (å·²ä¿®æ­£èªæ³•éŒ¯èª¤) ---
        const initCharts = () => {
            renderLineChart();
            renderRadarChart();
        };

        const renderLineChart = () => {
            const ctx = document.getElementById('workoutChart');
            if (!ctx) return;
            if (lineChartInstance) lineChartInstance.destroy();

            const dataMap = {};
            const source = [...enrichedLogs.value].reverse();
            const targetData = selectedCategory.value === "ALL" ? source : source.filter(l => l.category === selectedCategory.value);

            targetData.forEach(log => {
                if (!log.date) return;
                const d = log.date;
                const val = log.weightVal;
                if (!dataMap[d]) dataMap[d] = 0;
                
                if (chartMode.value === 'max') {
                    if (val > dataMap[d]) dataMap[d] = val;
                } else {
                    const s = parseFloat(log.sets) || 1;
                    const r = parseFloat(log.reps) || 1;
                    dataMap[d] += (val * s * r);
                }
            });

            const color = chartMode.value === 'max' ? '#3b82f6' : '#10b981'; 

            lineChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(dataMap),
                    datasets: [{
                        // ä¿®æ­£é»ï¼šé€™è£¡åŸæœ¬æ˜¯ç”¨ , éŒ¯èª¤ï¼Œç¾åœ¨æ”¹ç‚º : æ­£ç¢º  
                        label: chartMode.value === 'max' ? 'æœ€å¤§é‡é‡ (kg)' : 'è¨“ç·´ç¸½é‡ (vol)',
                        data: Object.values(dataMap),
                        borderColor: color,
                        backgroundColor: color + '20', 
                        borderWidth: 2,
                        tension: 0.4, 
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 6 } }
                    }
                }
            });
        };

        const renderRadarChart = () => {
            const ctx = document.getElementById('radarChart');
            if (!ctx) return;
            if (radarChartInstance) radarChartInstance.destroy();

            const catCounts = {};
            enrichedLogs.value.forEach(l => {
                const c = l.category;
                if(c === "æœªåˆ†é¡") return;
                catCounts[c] = (catCounts[c] || 0) + 1;
            });

            const labels = Object.keys(catCounts);
            const data = Object.values(catCounts);

            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'è¨“ç·´é »ç‡åˆ†ä½ˆ',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: '#3b82f6',
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: '#334155' },
                            grid: { color: '#334155' },
                            pointLabels: { color: '#cbd5e1', font: { size: 12 } },
                            ticks: { display: false, backdropColor: 'transparent' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        };

        // --- [ACTION] å¯«å…¥åŠŸèƒ½ ---
        const openEditModal = (log) => {
            editingItem.value = {
                exercise: log.exercise,
                newCategory: log.category === "æœªåˆ†é¡" ? "" : log.category,
                newBodyPart: log.bodyPart === "æœªçŸ¥" ? "" : log.bodyPart,
                newNote: log.noteVal || ""
            };
            showModal.value = true;
        };

        const saveCategory = async () => {
            if(isDemoMode.value) {
                alert("æ¼”ç¤ºæ¨¡å¼ä¸‹ç„¡æ³•å„²å­˜è‡³è³‡æ–™åº«ã€‚");
                showModal.value = false;
                return;
            }

            saving.value = true;
            try {
                await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "updateCategory",
                        exerciseName: editingItem.value.exercise,
                        newCategory: editingItem.value.newCategory,
                        newBodyPart: editingItem.value.newBodyPart,
                        newNote: editingItem.value.newNote
                    }),
                    headers: { "Content-Type": "text/plain" }
                });
                
                mapping.value[editingItem.value.exercise] = {
                    category: editingItem.value.newCategory,
                    bodyPart: editingItem.value.newBodyPart,
                    note: editingItem.value.newNote
                };
                showModal.value = false;
                nextTick(() => initCharts()); 
            } catch (e) {
                alert("å„²å­˜å¤±æ•—: " + e.message);
            } finally {
                saving.value = false;
            }
        };

        watch([currentView, selectedCategory, chartMode], () => {
            nextTick(() => initCharts());
        });

        onMounted(() => {
            fetchData();
        });

        return {
            loading, isDemoMode,
            stats, filteredList, uniqueCategories,
            currentView, searchQuery, selectedCategory, chartMode,
            fetchData,
            showModal, editingItem, openEditModal, saveCategory, saving
        };
    }
}).mount('#app');
</script>
</body>
</html>