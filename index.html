<!DOCTYPE html>
<html lang="zh-TW" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alpha Strength V2.1</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* UI/UX å„ªåŒ–ï¼šå­—é«”èˆ‡è§¸æ§ */
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #E2E8F0; font-size: 16px; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .card-bordered { border: 1px solid rgba(255,255,255,0.1); }
        /* æ—¥æœŸåˆ†çµ„æ¨™é¡Œ */
        .date-header { position: sticky; top: 0; z-index: 10; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-24">

<div id="app" class="flex flex-col h-full">

    <div class="navbar bg-base-200 border-b border-white/10 px-4 shadow-lg sticky top-0 z-30">
        <div class="flex-1">
            <span class="text-xl md:text-2xl font-black text-primary tracking-tight">Alpha<span class="text-white">Strength</span></span>
        </div>
        <div class="flex-none">
            <a :href="lineCallUrl" target="_blank" class="btn btn-circle btn-ghost text-success btn-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
            </a>
        </div>
    </div>

    <main class="p-4 md:p-6 space-y-8 flex-1 overflow-y-auto">
        
        <div v-if="loading" class="flex flex-col items-center justify-center py-20 space-y-4">
            <span class="loading loading-bars loading-lg text-primary"></span>
            <p class="text-gray-400 animate-pulse">æ•¸æ“šåŒæ­¥ä¸­...</p>
        </div>

        <div v-if="errorMsg" class="alert alert-error shadow-lg">
            <span>{{ errorMsg }}</span>
            <button class="btn btn-xs" @click="fetchData">é‡è©¦</button>
        </div>

        <div v-show="currentTab === 'dashboard'" class="space-y-6">
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="stat bg-base-200 rounded-2xl border border-white/5 p-3">
                    <div class="stat-title text-xs opacity-70">ç¸½è¨“ç·´é‡</div>
                    <div class="stat-value text-primary text-2xl font-mono">{{ stats.totalVolume }}</div>
                    <div class="stat-desc">kg (ç´¯ç©)</div>
                </div>
                <div class="stat bg-base-200 rounded-2xl border border-white/5 p-3">
                    <div class="stat-title text-xs opacity-70">ç¸½çµ„æ•¸</div>
                    <div class="stat-value text-secondary text-2xl font-mono">{{ stats.totalSets }}</div>
                    <div class="stat-desc">Sets</div>
                </div>
            </div>

            <div class="card bg-base-200 border border-white/5 shadow-xl">
                <div class="card-body p-4">
                    <div class="tabs tabs-boxed bg-base-300 mb-4">
                        <a class="tab flex-1" :class="{ 'tab-active': chartType === 'volume' }" @click="chartType = 'volume'">ğŸ“ˆ å®¹é‡è¶¨å‹¢</a>
                        <a class="tab flex-1" :class="{ 'tab-active': chartType === 'radar' }" @click="chartType = 'radar'">ğŸ•¸ï¸ éƒ¨ä½é›·é”</a>
                    </div>
                    
                    <div class="relative w-full h-64 md:h-80">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-xl font-bold px-1 flex justify-between items-center">
                    <span>ğŸ“… è¨“ç·´æ—¥èªŒ</span>
                    <span class="text-xs font-normal opacity-50">æœ€è¿‘ {{ Object.keys(groupedLogs).length }} å¤©</span>
                </h3>

                <div v-for="(logs, date) in groupedLogs" :key="date" class="collapse collapse-arrow bg-base-200 border border-white/5">
                    <input type="radio" name="log-accordion" checked="checked" /> 
                    <div class="collapse-title text-lg font-bold flex items-center gap-2">
                        <span class="text-primary">{{ date }}</span>
                        <span class="badge badge-sm badge-ghost">{{ logs.length }} å‹•ä½œ</span>
                    </div>
                    <div class="collapse-content px-2">
                        <div class="overflow-x-auto">
                            <table class="table table-sm w-full">
                                <thead>
                                    <tr class="text-gray-500 border-b-white/10">
                                        <th>å‹•ä½œ/å‚™è¨»</th>
                                        <th class="text-right">é‡ x æ¬¡ x çµ„</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="log in logs" :key="log.id" class="border-b-white/5 hover:bg-white/5">
                                        <td>
                                            <div class="font-bold text-lg">{{ log.Exercise }}</div>
                                            <div v-if="log.Note" class="text-xs text-gray-400 mt-1">ğŸ“ {{ log.Note }}</div>
                                            <div class="text-[10px] opacity-50 mt-1 badge badge-outline badge-xs">{{ log.BodyPart }}</div>
                                        </td>
                                        <td class="text-right font-mono text-base align-top pt-3">
                                            <span class="text-accent text-xl font-bold">{{ log.Weight }}</span>
                                            <span class="text-gray-500 text-xs">kg</span> 
                                            <div class="text-xs text-gray-400 mt-1">
                                                {{ log.Reps }} reps Ã— {{ log.Sets }} sets
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'tools'" class="max-w-md mx-auto pt-10">
            <div class="card bg-base-200 shadow-2xl border border-accent">
                <div class="card-body">
                    <h2 class="card-title text-2xl text-accent mb-4">ğŸ§® 1RM è¨ˆç®—æ©Ÿ</h2>
                    <div class="form-control">
                        <label class="label"><span class="label-text">é‡é‡ (Weight)</span></label>
                        <input type="number" v-model="calc.weight" class="input input-bordered input-lg font-mono text-xl" placeholder="kg">
                    </div>
                    <div class="form-control mt-4">
                        <label class="label"><span class="label-text">æ¬¡æ•¸ (Reps)</span></label>
                        <input type="number" v-model="calc.reps" class="input input-bordered input-lg font-mono text-xl" placeholder="reps">
                    </div>
                    <div class="divider">é ä¼°çµæœ</div>
                    <div class="text-center">
                        <div class="text-6xl font-mono font-black text-white">{{ estimated1RM }}</div>
                        <div class="text-sm opacity-50 mt-2">Epley Formula (kg)</div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div class="btm-nav btm-nav-lg bg-base-200 border-t border-white/10 z-40">
        <button :class="currentTab === 'dashboard' ? 'active text-primary' : ''" @click="currentTab = 'dashboard'">
            <span class="text-3xl">ğŸ“Š</span>
            <span class="btm-nav-label text-xs">æ•¸æ“šçœ‹æ¿</span>
        </button>
        <button :class="currentTab === 'tools' ? 'active text-accent' : ''" @click="currentTab = 'tools'">
            <span class="text-3xl">ğŸ§®</span>
            <span class="btm-nav-label text-xs">è¨ˆç®—æ©Ÿ</span>
        </button>
    </div>

</div>

<script>
    const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // ğŸš¨ è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ GAS Web App URL (çµå°¾æ˜¯ /exec)
            const API_URL = 'https://script.google.com/macros/s/AKfycbx2npaR9aZnvMvtkIRsRB1aTJVjuYZElACcqT3hZQZBaTE1ypbs9ewh7q_35T8AB0KdMA/exec';
            // ğŸš¨ è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ LINE Call URL
            const LINE_CALL_URL = 'https://lin.ee/Sh5UgkkJ';

            const loading = ref(true);
            const errorMsg = ref('');
            const rawData = ref([]);
            const currentTab = ref('dashboard');
            const chartType = ref('volume'); // volume or radar
            const lineCallUrl = ref(LINE_CALL_URL);
            
            // è¨ˆç®—æ©Ÿ state
            const calc = ref({ weight: '', reps: '' });

            // æ•¸æ“šç²å–
            const fetchData = async () => {
                loading.value = true; errorMsg.value = '';
                try {
                    const res = await fetch(`${API_URL}${API_URL.includes('?')?'&':'?'}type=json`);
                    const json = await res.json();
                    if (json.status === 'error') throw new Error(json.message);
                    
                    // æ•¸æ“šæ˜ å°„ (å¾Œç«¯å°å¯« -> å‰ç«¯å¤§å¯«)
                    if (json.data) {
                        rawData.value = json.data.map((r, i) => ({
                            id: i,
                            Date: r.date,
                            Exercise: r.exercise,
                            Weight: Number(r.weight),
                            Reps: Number(r.reps),
                            Sets: Number(r.sets),
                            Note: r.note,
                            // è‡ªå‹•åˆ†é¡ (Mapping)
                            BodyPart: (json.mapping && json.mapping[r.exercise]) ? json.mapping[r.exercise].bodyPart : 'æœªåˆ†é¡'
                        }));
                    }
                } catch (e) {
                    errorMsg.value = `è®€å–å¤±æ•—: ${e.message}`;
                } finally {
                    loading.value = false;
                }
            };

            // çµ±è¨ˆæ•¸æ“š
            const stats = computed(() => {
                const vol = rawData.value.reduce((acc, cur) => acc + (cur.Weight * cur.Reps * cur.Sets), 0);
                const sets = rawData.value.reduce((acc, cur) => acc + cur.Sets, 0);
                return {
                    totalVolume: (vol / 1000).toFixed(1) + 'k',
                    totalSets: sets
                };
            });

            // æ—¥æœŸåˆ†çµ„ (è§£æ±ºæµæ°´å¸³å•é¡Œ)
            const groupedLogs = computed(() => {
                const groups = {};
                // æ’åºï¼šæ–°åˆ°èˆŠ
                const sorted = [...rawData.value].sort((a, b) => new Date(b.Date) - new Date(a.Date));
                sorted.forEach(item => {
                    const d = item.Date; // Date å·²ç¶“æ˜¯ YYYY-MM-DD
                    if (!groups[d]) groups[d] = [];
                    groups[d].push(item);
                });
                return groups;
            });

            // 1RM è¨ˆç®—
            const estimated1RM = computed(() => {
                const w = parseFloat(calc.value.weight);
                const r = parseFloat(calc.value.reps);
                if (!w || !r) return 0;
                return Math.round(w * (1 + r / 30));
            });

            // åœ–è¡¨é‚è¼¯
            let chartInstance = null;
            
            const renderChart = () => {
                const ctx = document.getElementById('mainChart');
                if (!ctx) return;
                if (chartInstance) chartInstance.destroy();

                const isRadar = chartType.value === 'radar';
                
                // æº–å‚™æ•¸æ“š
                let labels = [], dataPoints = [], labelText = '';

                if (isRadar) {
                    // é›·é”åœ–ï¼šæŒ‰éƒ¨ä½çµ±è¨ˆå®¹é‡
                    const partMap = {};
                    rawData.value.forEach(d => {
                        const p = d.BodyPart || 'æœªåˆ†é¡';
                        if (!partMap[p]) partMap[p] = 0;
                        partMap[p] += (d.Weight * d.Reps * d.Sets);
                    });
                    labels = Object.keys(partMap);
                    dataPoints = Object.values(partMap);
                    labelText = 'éƒ¨ä½è¨“ç·´é‡ (kg)';
                } else {
                    // æŠ˜ç·šåœ–ï¼šæŒ‰æ—¥æœŸçµ±è¨ˆå®¹é‡
                    const dateMap = {};
                    // èˆŠåˆ°æ–°æ’åºä»¥ç•«åœ–
                    [...rawData.value].sort((a, b) => new Date(a.Date) - new Date(b.Date)).forEach(d => {
                        const date = d.Date;
                        if (!dateMap[date]) dateMap[date] = 0;
                        dateMap[date] += (d.Weight * d.Reps * d.Sets);
                    });
                    labels = Object.keys(dateMap);
                    dataPoints = Object.values(dateMap);
                    labelText = 'æ¯æ—¥è¨“ç·´é‡ (kg)';
                }

                chartInstance = new Chart(ctx, {
                    type: isRadar ? 'radar' : 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: labelText,
                            data: dataPoints,
                            borderColor: isRadar ? '#D926A9' : '#66CC8A',
                            backgroundColor: isRadar ? 'rgba(217, 38, 169, 0.2)' : 'rgba(102, 204, 138, 0.1)',
                            fill: true,
                            pointRadius: isRadar ? 3 : 4,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'nearest', intersect: false }, // V2.1 è§¸æ§å„ªåŒ–
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                titleFont: { size: 14 },
                                bodyFont: { size: 14 },
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw} kg`; // V2.1 Tooltip å–®ä½ä¿®æ­£
                                    }
                                }
                            }
                        },
                        scales: isRadar ? {
                            r: { 
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { display: false, backdropColor: 'transparent' },
                                pointLabels: { color: '#fff', font: { size: 12 } }
                            }
                        } : {
                            x: { grid: { display: false }, ticks: { color: '#666' } },
                            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666' } }
                        }
                    }
                });
            };

            // ç›£è½å™¨
            watch(loading, (val) => { if(!val) nextTick(renderChart); });
            watch(chartType, () => { nextTick(renderChart); });
            watch(currentTab, (val) => { if(val === 'dashboard') nextTick(renderChart); });

            onMounted(() => fetchData());

            return {
                loading, errorMsg, stats, groupedLogs, currentTab, chartType,
                calc, estimated1RM, lineCallUrl, rawData
            };
        }
    }).mount('#app');
</script>
</body>
</html>