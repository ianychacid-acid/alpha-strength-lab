<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --primary-color: #2c3e50;
        --accent-color: #3498db;
        --bg-color: #f4f7f6;
        --card-bg: #ffffff;
      }
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-color);
        margin: 0;
        padding: 20px;
        color: #333;
      }
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .chart-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        height: 350px;
        position: relative;
      }
      h2 { font-size: 1.2rem; margin-top: 0; color: var(--primary-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 8px; display: inline-block;}
      
      /* è¨­å®šæŒ‰éˆ•æ¨£å¼ */
      .btn-fix {
        background: none;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        padding: 2px 8px;
        font-size: 0.9rem;
      }
      .btn-fix:hover { background-color: #eee; }

      /* Modal è¦–çª—æ¨£å¼ */
      .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        display: none; justify-content: center; align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: white; padding: 25px; border-radius: 8px;
        width: 90%; max-width: 400px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      }
      .form-group { margin-bottom: 15px; }
      label { display: block; margin-bottom: 5px; font-weight: bold; }
      select, input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
      .modal-actions { text-align: right; margin-top: 20px; }
      .btn-save { background: var(--accent-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
      .btn-cancel { background: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; }
      
      #loading { text-align: center; padding: 50px; font-size: 1.2rem; color: #666; }
    </style>
  </head>
  <body>

    <div id="loading">
      æ•¸æ“šåˆ†æä¸­ï¼Œè«‹ç¨å€™... â³
    </div>

    <div id="main-content" style="display:none;">
      <div class="dashboard-grid">
        <div class="chart-card">
          <h2>çµæ§‹å¹³è¡¡ (Sets)</h2>
          <canvas id="radarChart"></canvas>
        </div>
        <div class="chart-card">
          <h2>é€±æœŸç›®æ¨™ (Sets)</h2>
          <canvas id="pieChart"></canvas>
        </div>
        <div class="chart-card">
          <h2>è¨“ç·´ç´€å¾‹ (é€±é »ç‡)</h2>
          <canvas id="freqChart"></canvas>
        </div>
      </div>

      <div class="chart-card" style="height: auto;">
        <h2>ğŸ› ï¸ å¿«é€Ÿä¿®æ­£å·¥å…· (The Fix-it Loop)</h2>
        <p>è‹¥ç™¼ç¾åœ–è¡¨åˆ†é¡éŒ¯èª¤ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ¸¬è©¦ä¿®æ­£åŠŸèƒ½ï¼š</p>
        <button class="btn-fix" onclick="openFixModal('æ·±è¹² (ç¯„ä¾‹)', 'ä¸‹è‚¢æ¨', 'æœ€å¤§è‚ŒåŠ›')">ğŸ”§ æ¸¬è©¦ä¿®æ­£ï¼šæ·±è¹²</button>
        <br><br>
        <small>* å¯¦éš›æ‡‰ç”¨æ™‚ï¼Œæ­¤æŒ‰éˆ•æœƒæ•´åˆåœ¨æ‚¨çš„è¨“ç·´ç´€éŒ„åˆ—è¡¨ä¸­ã€‚</small>
      </div>
    </div>

    <div id="fixModal" class="modal-overlay">
      <div class="modal-content">
        <h3 id="modalTitle">ä¿®æ­£å‹•ä½œåˆ†é¡</h3>
        <input type="hidden" id="fixName">
        
        <div class="form-group">
          <label>ä¸»é¡åˆ¥ (Category)</label>
          <select id="fixCategory"></select>
        </div>
        
        <div class="form-group">
          <label>è¨“ç·´ç›®çš„ (Purpose)</label>
          <select id="fixPurpose"></select>
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
          <button class="btn-save" onclick="saveMapping()">å„²å­˜ä¿®æ­£</button>
        </div>
      </div>
    </div>

    <script>
      let chartInstances = {}; // å„²å­˜åœ–è¡¨å¯¦ä¾‹ä»¥ä¾¿æ›´æ–°
      let globalOptions = {};  // å„²å­˜ä¸‹æ‹‰é¸å–®é¸é …

      // åˆå§‹åŒ–ï¼šè¼‰å…¥æ•¸æ“š
      window.onload = function() {
        google.script.run.withSuccessHandler(renderDashboard).getDashboardData();
      };

      function renderDashboard(data) {
        if(data.error) {
          document.getElementById('loading').innerHTML = "âŒ éŒ¯èª¤: " + data.error;
          return;
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        
        globalOptions = data.options; // å„²å­˜é¸é …ä¾› Modal ä½¿ç”¨

        // 1. ç¹ªè£½é›·é”åœ–
        renderRadarChart(data.radar);
        
        // 2. ç¹ªè£½åœ“é¤…åœ–
        renderPieChart(data.pie);

        // 3. ç¹ªè£½é »ç‡åœ–
        renderFreqChart(data.freq);
      }

      // --- åœ–è¡¨ç¹ªè£½å‡½å¼ ---

      function renderRadarChart(radarData) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        const labels = Object.keys(radarData);
        const values = Object.values(radarData);

        chartInstances.radar = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: labels,
            datasets: [{
              label: 'ç¸½çµ„æ•¸ (Sets)',
              data: values,
              backgroundColor: 'rgba(52, 152, 219, 0.2)',
              borderColor: 'rgba(52, 152, 219, 1)',
              borderWidth: 2
            }]
          },
          options: {
            scales: { r: { beginAtZero: true } },
            maintainAspectRatio: false
          }
        });
      }

      function renderPieChart(pieData) {
        const ctx = document.getElementById('pieChart').getContext('2d');
        chartInstances.pie = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(pieData),
            datasets: [{
              data: Object.values(pieData),
              backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
              ]
            }]
          },
          options: { maintainAspectRatio: false }
        });
      }

      function renderFreqChart(freqData) {
        const ctx = document.getElementById('freqChart').getContext('2d');
        const labels = freqData.map(d => d.week);
        const values = freqData.map(d => d.count);

        chartInstances.freq = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'æ¯é€±è¨“ç·´å¤©æ•¸',
              data: values,
              backgroundColor: values.map(v => v >= 3 ? '#2ecc71' : '#e74c3c') // >=3å¤©ç¶ è‰²ï¼Œå¦å‰‡ç´…è‰²
            }]
          },
          options: {
            scales: { y: { beginAtZero: true, max: 7 } },
            maintainAspectRatio: false
          }
        });
      }

      // --- Fix-it Loop äº’å‹•é‚è¼¯ ---

      function openFixModal(name, currentCat, currentPur) {
        document.getElementById('fixName').value = name;
        document.getElementById('modalTitle').innerText = "ä¿®æ­£ï¼š" + name;
        
        // å¡«å……ä¸‹æ‹‰é¸å–®
        const catSelect = document.getElementById('fixCategory');
        const purSelect = document.getElementById('fixPurpose');
        
        catSelect.innerHTML = "";
        purSelect.innerHTML = "";

        globalOptions.categories.forEach(opt => {
          let option = new Option(opt, opt);
          if(opt === currentCat) option.selected = true;
          catSelect.add(option);
        });
        
        globalOptions.purposes.forEach(opt => {
          let option = new Option(opt, opt);
          if(opt === currentPur) option.selected = true;
          purSelect.add(option);
        });

        document.getElementById('fixModal').style.display = 'flex';
      }

      function closeModal() {
        document.getElementById('fixModal').style.display = 'none';
      }

      function saveMapping() {
        const name = document.getElementById('fixName').value;
        const cat = document.getElementById('fixCategory').value;
        const pur = document.getElementById('fixPurpose').value;

        // å‘¼å«å¾Œç«¯
        google.script.run.withSuccessHandler(function(res) {
          alert(res.msg);
          closeModal();
          // é‡æ–°æ•´ç†åœ–è¡¨ (å¯é¸: åƒ…é‡æ–°æ’ˆè³‡æ–™è€Œä¸æ•´é åˆ·æ–°)
          location.reload(); 
        }).handleUpdateMapping(name, cat, pur);
      }
    </script>
  </body>
</html>