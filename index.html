<!DOCTYPE html>
<html lang="zh-TW" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alpha Strength V2.1</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0F172A; color: #E2E8F0; font-size: 16px; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        /* å„ªåŒ–å¡ç‰‡é‚Šæ¡†èˆ‡é™°å½± */
        .card-bordered { border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        /* è¡¨æ ¼å„ªåŒ– */
        .table-zebra tbody tr:nth-child(even) { background-color: rgba(255, 255, 255, 0.02); }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-24">

<div id="app" class="flex flex-col h-full">

    <div class="navbar bg-base-200 border-b border-white/10 px-4 shadow-lg sticky top-0 z-30">
        <div class="flex-1">
            <span class="text-xl md:text-2xl font-black text-primary tracking-tight">Alpha<span class="text-white">Strength</span></span>
        </div>
        <div class="flex-none">
            <a :href="lineCallUrl" target="_blank" class="btn btn-circle btn-ghost text-success btn-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
            </a>
        </div>
    </div>

    <main class="p-4 md:p-6 space-y-8 flex-1 overflow-y-auto">
        
        <div v-if="loading" class="flex flex-col items-center justify-center py-20 space-y-4">
            <span class="loading loading-bars loading-lg text-primary"></span>
            <p class="text-gray-400 animate-pulse">æ•¸æ“šåŒæ­¥ä¸­...</p>
        </div>

        <div v-if="errorMsg" class="alert alert-error shadow-lg">
            <span>{{ errorMsg }}</span>
            <button class="btn btn-xs" @click="fetchData">é‡è©¦</button>
        </div>

        <div v-show="!loading && currentTab === 'dashboard'" class="space-y-6">
            
            <div class="grid grid-cols-2 gap-3">
                <div class="stat bg-base-200 rounded-2xl border border-white/5 p-4">
                    <div class="stat-title text-xs opacity-70">æœ¬é€±è¨“ç·´é »ç‡</div>
                    <div class="stat-value text-primary text-3xl font-mono">{{ stats.weeklyFreq }} <span class="text-sm">æ¬¡</span></div>
                    <div class="stat-desc text-gray-400">ä¸Šæ¬¡è¨“ç·´ï¼š{{ stats.lastDate }}</div>
                </div>
                <div class="stat bg-base-200 rounded-2xl border border-white/5 p-4">
                    <div class="stat-title text-xs opacity-70">æœ€é«˜ 1RM ç´€éŒ„</div>
                    <div class="stat-value text-secondary text-3xl font-mono">{{ stats.max1RM }} <span class="text-sm">kg</span></div>
                    <div class="stat-desc text-gray-400 truncate">{{ stats.max1RMExercise }}</div>
                </div>
            </div>

            <div class="card bg-base-200 border border-white/5 shadow-xl">
                <div class="card-body p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="card-title text-lg">èº«é«”ç´ è³ªåˆ†æ</h3>
                        <div class="join">
                            <button class="join-item btn btn-xs md:btn-sm" :class="chartType==='radar'?'btn-primary':''" @click="chartType='radar'">ğŸ•¸ï¸ å¹³è¡¡</button>
                            <button class="join-item btn btn-xs md:btn-sm" :class="chartType==='trend'?'btn-secondary':''" @click="chartType='trend'">ğŸ“ˆ è¶¨å‹¢</button>
                        </div>
                    </div>
                    <div class="relative w-full h-64 md:h-72 flex justify-center">
                        <canvas id="mainChart"></canvas>
                    </div>
                    <div v-if="chartType === 'radar'" class="text-center text-xs text-gray-500 mt-2">
                        * åŸºæ–¼å„éƒ¨ä½ç´¯ç©è¨“ç·´å®¹é‡åˆ†æ
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <h3 class="text-xl font-bold px-1 flex items-center gap-2">
                    <span>ğŸ” è¨“ç·´æŸ¥è©¢</span>
                </h3>
                
                <div class="join w-full">
                    <input type="text" v-model="searchQuery" placeholder="æœå°‹å‹•ä½œ (å¦‚: æ·±è¹², èƒŒ)..." class="input input-bordered join-item w-full" />
                    <select v-model="selectedBodyPart" class="select select-bordered join-item max-w-[100px]">
                        <option value="">å…¨éƒ¨</option>
                        <option v-for="part in uniqueBodyParts" :key="part" :value="part">{{ part }}</option>
                    </select>
                </div>

                <div class="overflow-x-auto bg-base-200 rounded-xl border border-white/5 max-h-[400px] overflow-y-auto">
                    <table class="table table-pin-rows table-sm w-full">
                        <thead>
                            <tr class="bg-base-300 text-gray-400">
                                <th>æ—¥æœŸ</th>
                                <th>å‹•ä½œ / éƒ¨ä½</th>
                                <th class="text-right">å¼·åº¦ (kg x reps x sets)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="log in filteredLogs" :key="log.id" class="border-b-white/5">
                                <td class="font-mono text-xs opacity-70">{{ log.Date }}</td>
                                <td>
                                    <div class="font-bold text-sm">{{ log.Exercise }}</div>
                                    <span class="badge badge-xs badge-ghost opacity-50">{{ log.BodyPart }}</span>
                                    <div v-if="log.Note" class="text-xs text-warning mt-1">ğŸ“ {{ log.Note }}</div>
                                </td>
                                <td class="text-right font-mono">
                                    <div class="text-lg font-bold text-accent">{{ log.Weight }} <span class="text-xs text-gray-500">kg</span></div>
                                    <div class="text-xs text-gray-400">{{ log.Reps }} x {{ log.Sets }}</div>
                                    <div class="text-[10px] text-gray-600 mt-1">1RM: {{ log.OneRm }}</div>
                                </td>
                            </tr>
                            <tr v-if="filteredLogs.length === 0">
                                <td colspan="3" class="text-center py-8 text-gray-500">
                                    æ‰¾ä¸åˆ°ç›¸é—œç´€éŒ„ï¼Œè«‹å˜—è©¦å…¶ä»–é—œéµå­—
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'tools'" class="max-w-md mx-auto pt-10 px-4">
            <div class="card bg-base-200 shadow-2xl border border-accent">
                <div class="card-body">
                    <h2 class="card-title text-2xl text-accent mb-4">ğŸ§® 1RM è¨ˆç®—æ©Ÿ</h2>
                    <div class="form-control">
                        <label class="label"><span class="label-text">é‡é‡ (Weight)</span></label>
                        <input type="number" v-model="calc.weight" class="input input-bordered input-lg font-mono text-xl" placeholder="kg">
                    </div>
                    <div class="form-control mt-4">
                        <label class="label"><span class="label-text">æ¬¡æ•¸ (Reps)</span></label>
                        <input type="number" v-model="calc.reps" class="input input-bordered input-lg font-mono text-xl" placeholder="reps">
                    </div>
                    <div class="divider">é ä¼°çµæœ</div>
                    <div class="text-center">
                        <div class="text-6xl font-mono font-black text-white">{{ estimated1RM }}</div>
                        <div class="text-sm opacity-50 mt-2">Epley Formula (kg)</div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div class="btm-nav btm-nav-lg bg-base-200 border-t border-white/10 z-40">
        <button :class="currentTab === 'dashboard' ? 'active text-primary' : ''" @click="currentTab = 'dashboard'">
            <span class="text-2xl">ğŸ“Š</span>
            <span class="btm-nav-label text-xs">æ•¸æ“šçœ‹æ¿</span>
        </button>
        <button :class="currentTab === 'tools' ? 'active text-accent' : ''" @click="currentTab = 'tools'">
            <span class="text-2xl">ğŸ§®</span>
            <span class="btm-nav-label text-xs">è¨ˆç®—æ©Ÿ</span>
        </button>
    </div>

</div>

<script>
    const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // ğŸš¨ è¨­å®šå€
            const API_URL = 'https://script.google.com/macros/s/AKfycbx2npaR9aZnvMvtkIRsRB1aTJVjuYZElACcqT3hZQZBaTE1ypbs9ewh7q_35T8AB0KdMA/exec';
            const LINE_CALL_URL = 'https://lin.ee/Sh5UgkkJ';

            const loading = ref(true);
            const errorMsg = ref('');
            const rawData = ref([]);
            const currentTab = ref('dashboard');
            const chartType = ref('radar'); // radar or trend
            const searchQuery = ref('');
            const selectedBodyPart = ref('');
            const calc = ref({ weight: '', reps: '' });

            // æ•¸æ“šç²å–
            const fetchData = async () => {
                loading.value = true; errorMsg.value = '';
                try {
                    const res = await fetch(`${API_URL}${API_URL.includes('?')?'&':'?'}type=json`);
                    const json = await res.json();
                    if (json.status === 'error') throw new Error(json.message);
                    
                    // è³‡æ–™è™•ç†
                    if (json.data) {
                        rawData.value = json.data.map((r, i) => {
                            // Mapping é‚è¼¯ï¼šå¾å¾Œç«¯ API å–å¾— mapping å°ç…§
                            const mapInfo = (json.mapping && json.mapping[r.exercise]) || {};
                            return {
                                id: i,
                                Date: r.date, // æ ¼å¼: YYYY-MM-DD
                                Exercise: r.exercise,
                                Weight: Number(r.weight) || 0,
                                Reps: Number(r.reps) || 0,
                                Sets: Number(r.sets) || 0,
                                OneRm: Number(r.oneRm) || 0,
                                Note: r.note,
                                // è‹¥ç„¡å°æ‡‰éƒ¨ä½ï¼Œæ­¸é¡ç‚º "å…¶ä»–" ä»¥ä¾¿é›·é”åœ–é¡¯ç¤º
                                BodyPart: mapInfo.bodyPart || 'å…¶ä»–' 
                            };
                        });
                    }
                } catch (e) {
                    errorMsg.value = `æ•¸æ“šè®€å–å¤±æ•—: ${e.message}`;
                } finally {
                    loading.value = false;
                }
            };

            // çµ±è¨ˆæ•¸æ“š (Frequency & Max PR)
            const stats = computed(() => {
                if (!rawData.value.length) return { weeklyFreq: 0, lastDate: '-', max1RM: 0, max1RMExercise: '-' };
                
                // æœ¬é€±é »ç‡è¨ˆç®—
                const now = new Date();
                const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                const recentLogs = rawData.value.filter(d => new Date(d.Date) >= oneWeekAgo);
                // ä½¿ç”¨ Set è¨ˆç®—ä¸é‡è¤‡çš„è¨“ç·´æ—¥
                const uniqueDays = new Set(recentLogs.map(d => d.Date));
                
                // æ‰¾å‡ºæœ€å¤§ 1RM
                let maxLog = rawData.value[0];
                rawData.value.forEach(d => {
                    if (d.OneRm > maxLog.OneRm) maxLog = d;
                });

                return {
                    weeklyFreq: uniqueDays.size,
                    lastDate: rawData.value.sort((a,b) => new Date(b.Date) - new Date(a.Date))[0]?.Date || '-',
                    max1RM: maxLog.OneRm,
                    max1RMExercise: maxLog.Exercise
                };
            });

            // å”¯ä¸€éƒ¨ä½åˆ—è¡¨ (ä¾›ä¸‹æ‹‰é¸å–®)
            const uniqueBodyParts = computed(() => {
                const parts = new Set(rawData.value.map(d => d.BodyPart));
                return Array.from(parts).sort();
            });

            // éæ¿¾å¾Œçš„æ—¥èªŒ
            const filteredLogs = computed(() => {
                return rawData.value.filter(d => {
                    const matchSearch = d.Exercise.toLowerCase().includes(searchQuery.value.toLowerCase()) || 
                                      (d.BodyPart && d.BodyPart.includes(searchQuery.value));
                    const matchPart = selectedBodyPart.value ? d.BodyPart === selectedBodyPart.value : true;
                    return matchSearch && matchPart;
                }).sort((a, b) => new Date(b.Date) - new Date(a.Date)); // é è¨­æ–°åˆ°èˆŠ
            });

            // 1RM è¨ˆç®—
            const estimated1RM = computed(() => {
                const w = parseFloat(calc.value.weight);
                const r = parseFloat(calc.value.reps);
                return (w && r) ? Math.round(w * (1 + r / 30)) : 0;
            });

            // åœ–è¡¨æ¸²æŸ“
            let chartInstance = null;
            const renderChart = () => {
                const ctx = document.getElementById('mainChart');
                if (!ctx) return;
                if (chartInstance) chartInstance.destroy();

                // é›·é”åœ–ï¼šéƒ¨ä½å¹³è¡¡åˆ†æ
                if (chartType.value === 'radar') {
                    const partVol = {};
                    rawData.value.forEach(d => {
                        const p = d.BodyPart;
                        if (!partVol[p]) partVol[p] = 0;
                        partVol[p] += (d.Weight * d.Reps * d.Sets);
                    });

                    chartInstance = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: Object.keys(partVol),
                            datasets: [{
                                label: 'è¨“ç·´å®¹é‡åˆ†ä½ˆ',
                                data: Object.values(partVol),
                                backgroundColor: 'rgba(102, 204, 138, 0.4)',
                                borderColor: '#66CC8A',
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#66CC8A'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    angleLines: { color: 'rgba(255,255,255,0.1)' },
                                    grid: { color: 'rgba(255,255,255,0.1)' },
                                    pointLabels: { color: '#fff', font: { size: 14, weight: 'bold' } },
                                    ticks: { display: false, backdropColor: 'transparent' }
                                }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                } 
                // è¶¨å‹¢åœ–ï¼š1RM é€²æ­¥å¹…åº¦ (å–å‰ 5 å¤§å‹•ä½œ)
                else {
                    // ç°¡åŒ–é‚è¼¯ï¼šä¾æ—¥æœŸåŠ ç¸½ç¸½å®¹é‡
                    const dateVol = {};
                    // æ’åºï¼šèˆŠ -> æ–°
                    [...rawData.value].sort((a,b) => new Date(a.Date) - new Date(b.Date)).forEach(d => {
                        if (!dateVol[d.Date]) dateVol[d.Date] = 0;
                        dateVol[d.Date] += (d.Weight * d.Reps * d.Sets);
                    });

                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Object.keys(dateVol),
                            datasets: [{
                                label: 'æ¯æ—¥ç¸½å®¹é‡ (kg)',
                                data: Object.values(dateVol),
                                borderColor: '#D926A9',
                                backgroundColor: 'rgba(217, 38, 169, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: { display: false },
                                y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888' } }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            };

            // ç›£è½å™¨
            watch(loading, (val) => { if(!val) nextTick(renderChart); });
            watch(chartType, () => nextTick(renderChart));
            watch(currentTab, (val) => { if(val==='dashboard') nextTick(renderChart); });

            onMounted(fetchData);

            return {
                loading, errorMsg, rawData, currentTab, chartType, 
                searchQuery, selectedBodyPart, uniqueBodyParts, filteredLogs,
                stats, calc, estimated1RM, lineCallUrl: LINE_CALL_URL
            };
        }
    }).mount('#app');
</script>
</body>
</html>